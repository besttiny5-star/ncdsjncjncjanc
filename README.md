# Payment QA Telegram Bot

Этот проект содержит Telegram-бота на базе [aiogram 3.x](https://docs.aiogram.dev/) для сбора заявок на тестирование платежей,
статичную посадочную страницу (`index.html`) с deeplink-кнопками и демонстрационную веб-админку (`admin/index.html`) для мониторинга
и управления заказами.

В рамках актуальной версии бот, сайт и админ-панель работают как единая система:

- лендинг формирует payload калькулятора (`calc_v1`) и открывает Telegram-бота с готовой заявкой;
- бот создаёт заказы как по прямому диалогу, так и по payload из сайта, защищая от дубликатов и обращений в группах;
- aiohttp API (`/api/orders`, `/api/stats`) предоставляет реальные данные для админ-панели.

## Основные возможности бота
- Поддержка deeplink `/start` c payload `calc_v1`, совпадающим с калькулятором сайта. 【F:payment_qa_bot/services/payload.py†L9-L120】
- Пошаговый флоу со сбором гео, метода оплаты, числа тестов, опций payout, доступа к сайту и комментариев. 【F:payment_qa_bot/routers/public.py†L71-L369】【F:payment_qa_bot/keyboards/tests.py†L1-L20】
- Создание заказа в SQLite с учётом источника (`bot`/`site`), surcharges, хэша payload и статуса оплаты. 【F:payment_qa_bot/models/db.py†L27-L157】
- Фильтр работы только в личных сообщениях: при добавлении в группу бот просит написать в личку и не принимает заказы. 【F:payment_qa_bot/routers/public.py†L401-L436】
- Уведомления пользователю и админам после приёма заказа без дублирования по повторному payload. 【F:payment_qa_bot/routers/public.py†L482-L643】
- aiohttp API для админки с выдачей и обновлением заказов, а также статистикой. 【F:payment_qa_bot/api/server.py†L1-L120】

## Требования
- Python 3.10+
- SQLite (входит в стандартную библиотеку Python)

## Установка
```bash
python -m venv .venv
source .venv/bin/activate  # Linux/macOS
.venv\Scripts\activate    # Windows PowerShell

pip install -r requirements.txt
```

## Переменные окружения
| Переменная | Назначение |
|------------|------------|
| `TELEGRAM_BOT_TOKEN` | Токен бота из BotFather (обязателен). |
| `BOT_DB_PATH` или `DB_URL` | Путь к SQLite-файлу (по умолчанию `./bot.db`). |
| `PAYMENT_QA_ADMIN_IDS` или `ADMIN_IDS` | Список Telegram ID админов через запятую. |
| `BOT_DEFAULT_LANG` | Базовый язык (`en` или `ru`, по умолчанию `en`). |
| `BOT_GEO_WHITELIST` | Список доступных GEO через запятую (ISO-коды). |
| `P2P_WALLET_TRC20` | Реквизиты для оплаты (TRC-20). |
| `P2P_HELP_CONTACT` | Контакт поддержки, отображаемый пользователю. |
| `PAYLOAD_HMAC_SECRET` | Секрет для подписи payload с сайта (опционально). |
| `ENCRYPTION_KEY` | Ключ для шифрования логина/пароля клиента. |
| `BOT_API_HOST` | Хост для aiohttp API (по умолчанию `0.0.0.0`). |
| `BOT_API_PORT` | Порт для aiohttp API (по умолчанию `8081`). |

Пример экспорта (Linux/macOS):
```bash
export TELEGRAM_BOT_TOKEN="123456789:ABC"
export PAYMENT_QA_ADMIN_IDS="11111111,22222222"
```

## Запуск
```bash
python bot.py
```
Команда запускает aiogram-бота и aiohttp API. Бот принимает обновления до остановки процесса, а REST API становится доступен по адресу `http://<BOT_API_HOST>:<BOT_API_PORT>`.

### Запуск через Docker Compose

Для развёртывания на сервере Ubuntu можно использовать локальную сборку Docker-образа.

1. Скопируйте файл `.env.example` в `.env` и заполните переменные токена и списка администраторов.
2. Убедитесь, что каталог `data/` существует (он будет использован для хранения базы данных).
3. Запустите сервис командой:

```bash
docker compose up --build -d
```

Файл базы данных `orders.db` будет сохраняться на хосте в каталоге `data/` (контейнер использует путь `/app/data/orders.db`).

## Структура базы данных
При первом запуске автоматически создаётся таблица `orders` со столбцами, соответствующими техническому заданию: гео, метод оплаты, количество тестов, опции payout, комментарии, цена, хэш payload, статусы и временные метки. Репозиторий выполняет миграции колонок `payout_surcharge` и `payload_hash` при необходимости. 【F:payment_qa_bot/models/db.py†L39-L120】

## Работа с ботом
1. Пользователь открывает бот по deeplinkу с сайта или нажимает «Начать» напрямую.
2. Бот проверяет, что диалог личный, и проводит через выбор гео, метода оплаты и числа тестов.
3. Далее запрашиваются опции payout, сайт для тестирования и при необходимости — доступы.
4. После подтверждения бот создаёт заказ, отправляет резюме пользователю и уведомляет администраторов.
5. Команда `/my_orders` отображает историю заявок, `/order_<id>` выводит детали конкретной заявки.

## Обновление лендинга
В `index.html` калькулятор зеркалирует кнопки и опции бота (гео, метод оплаты, варианты payout, поле комментария). После выбора параметров формируется payload `calc_v1`, передающийся в Telegram-бот с кнопки «Начать тест». Перед релизом замените `BOT_USERNAME` в скрипте на имя вашего бота. 【F:index.html†L525-L1175】

## Демонстрационная админ-панель

Страница `admin/index.html` реализует ключевые элементы технического задания: четыре блока метрик с динамикой, набор интерактивных
графиков, ленту активности, фильтры и таблицу заказов с массовыми действиями, а также модальные окна с деталями заказа. JavaScript-модули
`admin/data.js` и `admin/app.js` получают реальные данные через эндпоинты бота (`/api/orders`, `/api/stats`), а `admin/order.js` загружает детали
по запросу. Интерфейс можно открыть локально, указав базовый URL API в `admin/data.js`.

Основные функции:
- Метрики и графики с возможностью экспорта изображений и сводки.
- Фильтры заказов с сохранением состояния, пагинацией, сортировкой и экспортом CSV.
- Массовые действия над заказами и карточки быстрых действий.
- Лента активности с поиском, фильтрацией и экспортом.
- Детальная карточка заказа с файлами, прогрессом, тестером и информацией об оплате.
