# Payment QA Telegram Bot

Этот проект содержит Telegram-бота на базе [aiogram 3.x](https://docs.aiogram.dev/) для сбора заявок на тестирование платежей,
статичную посадочную страницу (`index.html`) с deeplink-кнопками и демонстрационную веб-админку (`admin/index.html`) для мониторинга
и управления заказами.

## Основные возможности бота
- Поддержка deeplink `/start pkg_<package>_geo_<country>` из лендинга.
- Пошаговый флоу со сбором данных (сайт, доступы, метод оплаты, комментарии, вложения).
- Создание заказа в SQLite с присвоением номера и статусом `awaiting_payment`.
- Отправка реквизитов для оплаты и приём подтверждающих файлов.
- Команды `/my_orders`, `/order_XXXXX` для клиентов и `/admin`, `/pending`, `/paid`, `/active` для администраторов.
- Хранение файловых идентификаторов и заметок в JSON-формате.

## Требования
- Python 3.10+
- SQLite (входит в стандартную библиотеку Python)

## Установка
```bash
python -m venv .venv
source .venv/bin/activate  # Linux/macOS
.venv\Scripts\activate    # Windows PowerShell

pip install -r requirements.txt
```

## Переменные окружения
| Переменная | Назначение |
|------------|------------|
| `TELEGRAM_BOT_TOKEN` | Токен бота из BotFather (обязателен). |
| `BOT_DB_PATH` | Путь к SQLite-файлу (по умолчанию `orders.db`). |
| `PAYMENT_QA_ADMIN_IDS` | Список Telegram ID админов через запятую. |

Пример экспорта (Linux/macOS):
```bash
export TELEGRAM_BOT_TOKEN="123456789:ABC"
export PAYMENT_QA_ADMIN_IDS="11111111,22222222"
```

## Запуск
```bash
python bot.py
```
Бот будет принимать обновления до остановки процесса.

### Запуск через Docker Compose

Для развёртывания на сервере Ubuntu можно использовать локальную сборку Docker-образа.

1. Скопируйте файл `.env.example` в `.env` и заполните переменные токена и списка администраторов.
2. Убедитесь, что каталог `data/` существует (он будет использован для хранения базы данных).
3. Запустите сервис командой:

```bash
docker compose up --build -d
```

Файл базы данных `orders.db` будет сохраняться на хосте в каталоге `data/` (контейнер использует путь `/app/data/orders.db`).

## Структура базы данных
При первом запуске автоматически создаётся таблица `orders` со столбцами, соответствующими техническому заданию (статусы, ссылки, комментарии, файлы, временные метки).

## Работа с ботом
1. Пользователь переходит по deeplink с сайта (`pkg_single_geo_IN`).
2. Бот отображает описание пакета и проводит через 4 шага ввода.
3. После подтверждения создаётся заказ, клиент получает реквизиты и клавиатуру для загрузки чека.
4. Команда `/my_orders` показывает историю заказов, `/order_<номер>` выводит детали конкретного.
5. Администраторы получают доступ к панели `/admin` и выборкам `/pending`, `/paid`, `/active`.

## Обновление лендинга
В `index.html` добавлены кнопки с классом `order-btn` и скрипт, генерирующий deeplink в Telegram на основе выбранного GEO.

## Демонстрационная админ-панель

Страница `admin/index.html` реализует ключевые элементы технического задания: четыре блока метрик с динамикой, набор интерактивных
графиков, ленту активности, фильтры и таблицу заказов с массовыми действиями, а также модальные окна с деталями заказа. Данные
загружаются из `admin/data.js` и имитируют работу реального бэкенда, поэтому интерфейс можно открыть локально в браузере без
запуска сервера.

Основные функции:
- Метрики и графики с возможностью экспорта изображений и сводки.
- Фильтры заказов с сохранением состояния, пагинацией, сортировкой и экспортом CSV.
- Массовые действия над заказами и карточки быстрых действий.
- Лента активности с поиском, фильтрацией и экспортом.
- Детальная карточка заказа с файлами, прогрессом, тестером и информацией об оплате.
